---
title: View Transition API
date: '2024-07-30'
tags: ['css', 'javascript']
draft: false
summary: æœ€æ–°åŠ¨ç”» View Transition API çš„ä½¿ç”¨ä»‹ç»ä¸ä»£ç å®è·µ
---

## å…±äº«å…ƒç´ åŠ¨ç”»

æœ€æ—©ç”± Google åœ¨å…¶ Material Design è§„èŒƒä¸­å¼•å…¥å¹¶æ¨å¹¿ã€‚åœ¨ Android åº”ç”¨ä¸­è¢«å¹¿æ³›ä½¿ç”¨ï¼Œé€šè¿‡åœ¨é¡µé¢æˆ–è§†å›¾ä¹‹é—´å¹³æ»‘åœ°è¿‡æ¸¡å…±äº«çš„å…ƒç´ ï¼Œèµ·åˆ°è¿‡æ¸¡å¹¶å¼•å¯¼çš„ä½œç”¨ã€‚é€šè¿‡åˆç†åˆ©ç”¨å…±äº«å…ƒç´ åŠ¨ç”»ï¼Œå¯ä»¥æ˜¾è‘—æå‡ç”¨æˆ·ä½“éªŒå’Œç•Œé¢çš„è§†è§‰è¿è´¯æ€§ã€‚[åœ¨æ‰€æœ‰è¿‡æ¸¡æ•ˆæœä¸­ï¼Œå…±äº«å…ƒç´ åŠ¨ç”»è¢«è®¤ä¸ºæ˜¯æœ€å…·æœ‰è¡¨ç°åŠ›çš„](https://m3.material.io/styles/motion/transitions/transition-patterns#16ba9505-e33a-47e6-862d-d341b9a361fd)

<img src="/static/images/android-share-element.gif" />

## ä½¿ç”¨

View Transitions API æä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œå¯ä»¥åœ¨æ›´æ–° DOM å†…å®¹çš„åŒæ—¶ï¼Œè½»æ¾åœ°åˆ›å»ºä¸åŒ DOM çŠ¶æ€ä¹‹é—´çš„åŠ¨ç”»è¿‡æ¸¡ã€‚å…¶åŸç†ç®€å•æ¥è¯´å°±æ˜¯ï¼š

1. åœ¨ `startViewTransition` è°ƒç”¨æ—¶æˆªå–ä¸€å¸§
2. æ‰§è¡Œä¼ å…¥ `startViewTransition` çš„å›è°ƒï¼Œå¹¶ç­‰å¾…ç•Œé¢å“åº”æ›´æ–°
3. DOM æ›´æ–°åï¼Œå†æˆªå–æ–°å…ƒç´ 
4. æ‰§è¡Œè¿‡æ¸¡ï¼Œé»˜è®¤æƒ…å†µä¸‹æ—§å¸§æ·¡å‡ºï¼Œæ–°å…ƒç´ æ·¡å…¥

`startViewTransition()` è¿”å›äº†ä¸€ç»„ promise ä»¥æä¾›äº†åœ¨è¿‡æ¸¡åˆ°è¾¾ä¸åŒçŠ¶æ€æ—¶è¿è¡Œä»£ç çš„èƒ½åŠ›

- `ready` ä¼ªå…ƒç´ æ ‘è¢«åˆ›å»ºä¸”è¿‡æ¸¡åŠ¨ç”»å³å°†å¼€å§‹æ—¶
- `finished` åŠ¨ç”»å®Œæˆï¼Œæ–°çš„é¡µé¢è§†å›¾å¯¹ç”¨æˆ·å¯è§ä¸”å¯äº¤äº’
- `updateCallbackDone` ä¼ é€’ç»™ `startViewTransition()` çš„å›è°ƒå‡½æ•°è¿”å›çš„ Promise å…‘ç°æ—¶ï¼Œè¯¥ Promise ä¹Ÿä¼šå…‘ç°

è¿˜æä¾›äº† `skipTransition()` å¯ä»¥è·³è¿‡è§†å›¾è¿‡æ¸¡çš„åŠ¨ç”»éƒ¨åˆ†ï¼Œä½†ä¸ä¼šè·³è¿‡ callback è°ƒç”¨

è¯¥ API åŒæ—¶è¿˜æœ‰ CSS æ‰©å±•éƒ¨åˆ†

```
::view-transition
â””â”€ ::view-transition-group(root)
   â””â”€ ::view-transition-image-pair(root)
      â”œâ”€ ::view-transition-old(root) ğŸ‘ˆ Screenshot
      â””â”€ ::view-transition-new(root) ğŸ‘ˆ Live representation
```

å¯ä»¥ä½¿ç”¨ä¼ªå…ƒç´ ç»™æ—§å¸§æˆ–è€…æ–°å…ƒç´ å¢åŠ åŠ¨ç”»

```css
::view-transition-old(root) {
  animation: move-from-old .5s forwards; // æ·»åŠ é€€åœºåŠ¨ç”»
}
::view-transition-new(root) {
  animation: move-to-new 1s; // æ·»åŠ ç™»åœºåŠ¨ç”»
}
```

## è·Ÿ UI æ¡†æ¶é›†æˆ

è·Ÿ UI æ¡†æ¶é›†æˆçš„å…³é”®åœ¨äº**å¦‚ä½•çŸ¥é“æ¡†æ¶æ›´æ–° dom åçš„æ—¶æœº**ï¼ˆä¸ç®¡æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥ï¼‰ï¼Œæ‰èƒ½åœ¨ `startViewTransition` çš„å›è°ƒç»“æŸå‰ç¡®ä¿ dom å·²ç»æ›´æ–°å®Œæˆï¼Œç„¶åæµè§ˆå™¨æ‰å¯ä»¥æˆªå–æ–°å¸§è¿›è¡Œè¿‡æ¸¡

### React

react æä¾›äº† [`flushSync`](https://zh-hans.react.dev/reference/react-dom/flushSync) APIï¼Œå¯ä»¥å¼ºåˆ¶è®© React åœ¨æä¾›çš„å›è°ƒå‡½æ•°å†…åŒæ­¥åˆ·æ–°ä»»ä½•æ›´æ–°ï¼Œç¡®ä¿ DOM ç«‹å³æ›´æ–°ã€‚

åœ¨ `startViewTransition` å›è°ƒä¸­åº”ç”¨ `flushSync` å°† setState çš„å¼‚æ­¥æ›´æ–°å¼ºåˆ¶æˆåŒæ­¥ï¼Œæµè§ˆå™¨å°±å¯ä»¥æ­£ç¡®æˆªå–åˆ° react æ›´æ–° dom åçš„æ–°å¸§ï¼Œç„¶ååº”ç”¨è¿‡æ¸¡

```js
export default function Count() {
  const [count, setCount] = useState(0);
  const plus = () => document.startViewTransition(() => {
    flushSync(() => {
      setCount(count + 1);
    })
  })
  return (
    <div>
      <div className="count">{count}</div>
      <button onClick={plus}>Plus</button>
    </div>
  );
}
```

æ›´å¥½çš„åšæ³•æ˜¯ [`useLayoutEffect`](https://zh-hans.react.dev/reference/react/useLayoutEffect)

```js
function useViewTransition(update: () => void) {
  const resolveRef = useRef<() => void>();
  useLayoutEffect(() => {
    if (resolveRef.current) {
      resolveRef.current();
      resolveRef.current = undefined;
    }
  });
  return function updateWithTransition() {
    document.startViewTransition(() => {
      return new Promise<void>((resolve) => {
        update();
        resolveRef.current = resolve;
      });
    });
  };
}

// App.tsx
const plus = useViewTransition(() => {
  setCount((count) => count + 1);
})
```

ä¸è¿‡å•ç»„ä»¶å†…è¿‡æ¸¡å¯ä»¥ä½¿ç”¨ `useLayoutEffect`ï¼Œä½†æ¶‰åŠ router ç»„ä»¶åˆ‡æ¢æ—¶å°±éœ€è¦å°† `useLayoutEffect` çš„é€»è¾‘æå‡æˆ–è€…ç›´æ¥ä½¿ç”¨ `flushSync`

**åœ¨ react-router ä¸­ä½¿ç”¨**

ç”±äº react-router v6 æ¨èä½¿ç”¨ [Data APIs](https://reactrouter.com/en/main/routers/picking-a-router)ï¼Œ
æˆ‘ä»¬æ— æ³•å°† `useLayoutEffect` çš„é€»è¾‘æå‡ï¼Œå› æ­¤ç›´æ¥æ”¯æŒäº† [`unstable_viewtransition`](https://reactrouter.com/en/main/components/link#unstable_viewtransition) 
åœ¨è·¯ç”±è·³è½¬æ—¶é»˜è®¤å¯ç”¨ `document.startViewTransition` åŒæ—¶æä¾›äº† [`unstable_useViewTransitionState()`](https://reactrouter.com/en/main/hooks//use-view-transition-state) hook æ¥åˆ¤æ–­è¿‡æ¸¡æ˜¯å¦æ­£åœ¨è¢«å¯ç”¨

æˆ–è€…ç›´æ¥ä½¿ç”¨ `flushSync` ä¹Ÿæ²¡å•¥é—®é¢˜

```js
import { flushSync } from 'react-dom'
import { useNavigate } from 'react-router-dom'

export default function useNavigateWithTransition() {
  const navigate = useNavigate()
  return function (to) {
    document.startViewTransition(() => {
      flushSync(() => {
        navigate(to)
      });
    });
  }
}
```

### Vue

vue æä¾›äº† `nextTick` APIï¼Œæ‰§è¡Œè¿”å›ä¸€ä¸ª promiseï¼Œä¼šåœ¨ä¸‹ä¸€æ¬¡ dom æ›´æ–°åå…‘ç°

åœ¨ `startViewTransition` å›è°ƒä¸­è¿›è¡Œ vue-router ç»„ä»¶åˆ‡æ¢ï¼ŒåŒæ—¶è¿”å› `nextTick()` promiseï¼Œ`startViewTransition` å°±ä¼šç­‰å¾… `nextTick()` å…‘ç°åå†å»æˆªå–æ–°å…ƒç´ ï¼Œç„¶åæ­£ç¡®åº”ç”¨ view transition è¿‡æ¸¡åŠ¨ç”»

```js
import { nextTick } from 'vue'
import { useRouter } from 'vue-router'

export default function useNavigateWithTransition() {
  const router = useRouter()
  return function navigate(path) {
    document.startViewTransition(() => {
      router.push(path)
      return nextTick()
    })
  }
}
```

å…¶ä»– UI æ¡†æ¶çš„é›†ç¾¤è¿™é‡Œä¸å†ä¸¾ä¾‹ï¼Œåªè¦æ¡†æ¶æä¾›äº†èƒ½è§£å†³[å…³é”®é—®é¢˜](#è·Ÿ-ui-æ¡†æ¶é›†æˆ)çš„ API å³å¯

## MPA è·¨æ–‡æ¡£è§†å›¾è½¬æ¢

chrome 126 ç‰ˆæœ¬æ­£å¼æ”¯æŒäº† MPA è·¨æ–‡æ¡£è§†å›¾è½¬æ¢ï¼Œè¯•ç”¨æœ¬ä¾‹å­å‰è¯·æ³¨æ„å…¼å®¹æ€§

å¯ç”¨ MPA è¿‡æ¸¡è¦æ±‚ä»…é€‚ç”¨äº**åŒæºé¡µé¢**ï¼ŒMPA è¿‡æ¸¡ä½¿ç”¨æ—§é¡µé¢è·³è½¬å‰ä½œä¸ºæ—§å¸§ï¼Œè·³è½¬åä¸ºæ–°å¸§

1. è¿™ç§æƒ…å†µä¸‹æ²¡æ³•è°ƒç”¨ `startViewTransition` å› æ­¤éœ€è¦åœ¨ css ä¸­æ–°å¢ `@view-transition` at-rule æ ‡è®°
  ```css
  @view-transition {
    navigation: auto;
  }
  ```
2. pageswap å’Œ pagereveal äº‹ä»¶
  - pageswap äº‹ä»¶åœ¨ç½‘é¡µæœ€åä¸€å¸§å‘ˆç°ä¹‹å‰è§¦å‘ã€‚å¯ä»¥åœ¨æ­¤æ—¶æœºåšæœ€åçš„ä¿®æ”¹ã€‚
  - pagereveal äº‹ä»¶ä¼šåœ¨ç½‘é¡µä¸Šå®Œæˆåˆå§‹åŒ–é¦–æ¬¡å‘ˆç°æœºä¼šä¹‹å‰è§¦å‘ã€‚å¯ä»¥åœ¨æˆªå–æ–°å¸§ä¹‹å‰è‡ªå®šä¹‰æ–°é¡µé¢ã€‚

ä¸å•é¡µé¢è¿‡æ¸¡ä¸€æ ·ï¼Œæµè§ˆå™¨è‡ªåŠ¨é€‰å–ä¸¤ä¸ªé¡µé¢ä¸­ç›¸åŒ `view-transition-name` çš„å…ƒç´ ï¼Œä»¥ group ä¸ºå•ä½è¿›è¡Œå‰åçš„è¡¥é—´åŠ¨ç”»è¿‡æ¸¡
